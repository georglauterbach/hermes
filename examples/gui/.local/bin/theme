#! /usr/bin/env -S bash -eE -u -o pipefail -O inherit_errexit

function log_warn() {
  echo "WARN  ${1:?Log warning message required}" >&2
  ERROR_OCCURRED=true
}

function set_theme_alacritty() {
  local CONFIG_FILE="${HOME}/.config/alacritty/30-colors-${COMPLETE_THEME_NAME}.toml"

  if [[ -f ${CONFIG_FILE} ]] && ! ln --symbolic --force \
    "${CONFIG_FILE}" \
    "${HOME}/.config/alacritty/33-colors_active.toml"; then
    log_warn 'Could not update color theme of Alacritty'
  fi
}

function set_theme_rofi() {
  local CONFIG_FILE="${HOME}/.config/rofi/config.rasi"

  if [[ -f ${CONFIG_FILE} ]] && ! sed --in-place --regexp-extended \
    "s/(theme )\".*\"/\1\"${COMPLETE_THEME_NAME}\"/" \
    "${CONFIG_FILE}"; then
    log_warn 'Could not update color theme of Rofi'
  fi
}

function set_theme_swaylock() {
  local CONFIG_FILE="${HOME}/.config/swaylock/${COMPLETE_THEME_NAME}"

  if [[ -f ${CONFIG_FILE} ]] && ! ln --symbolic --force \
    "${CONFIG_FILE}" \
    "${HOME}/.config/swaylock/config"; then
    log_warn 'Could not update color theme of Swaylock'
  fi
}

function set_theme_zellij() {
  local CONFIG_FILE="${HOME}/.config/zellij/config.kdl"

  if [[ -f ${CONFIG_FILE} ]] && ! sed --in-place --regexp-extended \
    "s/(theme )\".*\"/\1\"${COMPLETE_THEME_NAME}\"/" \
    "${CONFIG_FILE}"; then
    log_warn 'Could not update color theme of Zellij'
  fi
}

function set_theme_regolith() {
  regolith-look set "${COMPLETE_THEME_NAME}" &
  readonly REGOLITH_LOOK_PID=${!}

  gsettings set 'org.gnome.desktop.interface' 'color-scheme' "prefer-${THEME_PALETTE}"
}

function main() {
  local THEME_PALETTE THEME_NAME COMPLETE_THEME_NAME

  case "${1:-dark}" in
    ( 'd' | 'dark' )
      readonly THEME_PALETTE='dark'
      readonly THEME_NAME='gruvbox-material'
      ;;

    ( 'l' | 'light' )
      readonly THEME_PALETTE='light'
      readonly THEME_NAME='everforest'
      ;;

    ( * )
      echo "'${1}' is not a valid option - use 'light|l' or 'dark|d'" >&2
      exit 1
      ;;
  esac

  readonly COMPLETE_THEME_NAME="${THEME_NAME}-${THEME_PALETTE}"

  set_theme_regolith

  set_theme_alacritty
  set_theme_rofi
  set_theme_swaylock
  set_theme_zellij

  wait -f "${REGOLITH_LOOK_PID}" || :

  if ${ERROR_OCCURRED:-false}; then
    exit 1
  else
    exit 0
  fi
}

main "${@}"
